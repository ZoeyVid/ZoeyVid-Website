<meta charset=utf-8>
<div class="markdown-heading"><h1 class="heading-element">NPMplus</h1><a id="user-content-npmplus" class="anchor" aria-label="Permalink: NPMplus" href="#npmplus"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>If you don't need the web GUI of NPMplus, you may also have a look at caddy: <a href="https://caddyserver.com" rel="nofollow">https://caddyserver.com</a></p>
<ul>
<li><a href="#compatibility-to-upstream">Compatibility (to Upstream)</a></li>
<li><a href="#quick-setup">Quick Setup</a></li>
<li><a href="#migration-from-upstreamvanilla-nginx-proxy-manager">Migration from upstream/vanilla nginx-proxy-manager</a></li>
</ul>
<p><strong>Note: this fork is distributed under the GNU Affero General Public License version 3. It is based on the MIT licensed <a href="https://github.com/NginxProxyManager/nginx-proxy-manager">nginx-proxy-manager</a>.</strong> <br>
<strong>Note: by running NPMplus you agree to the TOS of Let's Encrypt/your custom CA.</strong> <br>
<strong>Note: remember to expose udp/quic for the https port (443/upd).</strong> <br>
<strong>Note: remember to add your domain to the <a href="https://hstspreload.org" rel="nofollow">hsts preload list</a> if you enabled hsts for your domain.</strong> <br>
<strong>Note: please report issues first to this fork before reporting them to the upstream repository.</strong> <br></p>
<div class="markdown-heading"><h2 class="heading-element">List of some changes</h2><a id="user-content-list-of-some-changes" class="anchor" aria-label="Permalink: List of some changes" href="#list-of-some-changes"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<ul>
<li>Supports HTTP/3 (QUIC), requires you to expose https with udp</li>
<li>Support for crowdsec and openappsec</li>
<li>Support for acme profiles (letsencrypt shortlived is used by default)</li>
<li>Improved support for different acme servers (like ocsp/must-staple)</li>
<li>OIDC support</li>
<li>smaller image based on alpine</li>
<li>ML-KEM support (also hardened TLS settings enforced)</li>
<li>https for the NPMplus interface</li>
<li>Goaccess included</li>
<li>punycode domain support</li>
<li>zstd and brotli</li>
<li>basic security headers always send</li>
<li>allow empty ports to support loadbalancing</li>
<li>proxy protocol support</li>
<li>improved nginx build and nginx templates</li>
<li>file and php server support (and fancyindex)</li>
<li>option to edit custom certs</li>
<li>gravatars are cached locally and fetched by the backend (better privacy by not exposing you directly to gravatar)</li>
<li>qrcodes for totp are generated locally in your browser instead of using a third-party api (better privacy/security by not exposing you and the secret to the third-party api)</li>
<li>re-added some things that where removed with upstreams new frontend</li>
<li>use secure cookied instead of local storage to save the token</li>
<li>Password reset (only sqlite) using <code>docker exec -it npmplus password-reset.js USER_EMAIL PASSWORD</code>
</li>
<li>many other things, see this README.md and the compose.yaml</li>
</ul>
<div class="markdown-heading"><h2 class="heading-element">Compatibility (to Upstream)</h2><a id="user-content-compatibility-to-upstream" class="anchor" aria-label="Permalink: Compatibility (to Upstream)" href="#compatibility-to-upstream"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<ul>
<li>Supported architectures: x86_64-v2/amd64v2 (check with <code>/lib/ld-linux-x86-64.so.2 --help</code>, plain x86-64 is not supported only v2 and up) and aarch64/arm64 (other archs (including 64-bit ones) and any 32-bit arch (like armhf/armv7 (dropped), armel/armv6) are not supported, because of the duration to compile).</li>
<li>I test NPMplus with docker, but podman should also work (I disrecommend you to run the NPMplus container inside an LXC container, it will work, but please don't do it, it will work better without, install docker/podman on the host or in a KVM and run NPMplus with this)</li>
<li>MariaDB(/MySQL)/PostgreSQL may work as Databases for NPMplus (configuration like in upstream), but are unsupported, have no advantage over SQLite (at least with NPMplus) and are not recommended. Please note that you can't migrate from any of these to SQLite without making a fresh install and/or copying everything yourself.</li>
<li>NPMplus uses https instead of http for the admin interface</li>
<li>NPMplus won't trust cloudflare until you set the env TRUST_CLOUDFLARE to true, but please read <a href="#notes-on-cloudflare">this</a> first before setting the env to true.</li>
<li>route53 is not supported as dns-challenge provider and Amazon CloudFront IPs can't be automatically trusted in NPMplus, even if you set TRUST_CLOUDFLARE env to true.</li>
<li>The following certbot dns plugins have been replaced, which means that certs using one of these proivder will not renew and need to be recreated (not renewed): <code>certbot-dns-he</code>, <code>certbot-dns-dnspod</code>, <code>certbot-dns-online</code>, <code>certbot-dns-powerdns</code> and <code>certbot-dns-do</code> (<code>certbot-dns-do</code> was replaced in upstream with v2.12.4 and then merged into NPMplus)</li>
<li>There are many changed and improvements to the nginx config, so please don't follow guides in the internet about custom/advanced config, they are either redundant or should not be used at all with NPMplus</li>
<li>Many forms have changed behavior, see <a href="#comments-on-some-buttons">Comments on some buttons</a>
</li>
</ul>
<div class="markdown-heading"><h2 class="heading-element">Quick Setup</h2><a id="user-content-quick-setup" class="anchor" aria-label="Permalink: Quick Setup" href="#quick-setup"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<ol>
<li>Install Docker and Docker Compose (podman or docker rootless may also work)</li>
</ol>
<ul>
<li><a href="https://docs.docker.com/engine/install" rel="nofollow">Docker Install documentation</a></li>
<li><a href="https://docs.docker.com/compose/install/linux" rel="nofollow">Docker Compose Install documentation</a></li>
</ul>
<ol start="2">
<li>Download this <a href="https://raw.githubusercontent.com/ZoeyVid/NPMplus/refs/heads/develop/compose.yaml" rel="nofollow">compose.yaml</a> (or use its content as a portainer stack)</li>
<li>Adjust TZ and ACME_EMAIL to your values and maybe adjust other env options to your needs</li>
<li>Start NPMplus by running (or deploy your portainer stack)</li>
</ol>
<div class="highlight highlight-source-shell"><pre>docker compose up -d</pre></div>
<ol start="5">
<li>Log in to the Admin UI: When your docker container is running, connect to the admin interface using <code>https://</code> on port <code>81</code>.</li>
</ol>
<div class="markdown-heading"><h2 class="heading-element">Migration from upstream/vanilla nginx-proxy-manager</h2><a id="user-content-migration-from-upstreamvanilla-nginx-proxy-manager" class="anchor" aria-label="Permalink: Migration from upstream/vanilla nginx-proxy-manager" href="#migration-from-upstreamvanilla-nginx-proxy-manager"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<ul>
<li>
<strong>NOTE: Migrating back to the original version is not possible.</strong> Please make a <strong>backup</strong> before migrating, so you have the option to revert if needed</li>
</ul>
<ol>
<li>Please read <a href="#compatibility-to-upstream">this</a> first</li>
<li>make a backup of your data and letsencrypt folders (creating a copy using <code>cp -a</code> should be enough)</li>
<li>download the latest compose.yaml of NPMplus</li>
<li>adjust your paths (of /etc/letsencrypt and /data) to the ones you used with nginx-proxy-manager</li>
<li>adjust TZ and ACME_EMAIL to your values and maybe adjust other env options to your needs</li>
<li>stop nginx-proxy-manager</li>
<li>deploy the NPMplus compose.yaml</li>
<li>You should now remove the <code>/etc/letsencrypt</code> mount, since it was moved to <code>/data</code> while migration, then redeploy the compose file</li>
<li>Since many forms have changed, please check if they are still correct for every host you have.</li>
<li>If you proxy NPM(plus) through NPM(plus) make sure to change the scheme from http to https</li>
<li>Because of a added CSP-rules gravatar images will not load, to fix this you need to open the form to edit a users name and save it without changes</li>
<li>Maybe setup crowdsec (see below)</li>
<li>Please report all (migration) issues you may have</li>
</ol>
<div class="markdown-heading"><h1 class="heading-element">Crowdsec</h1><a id="user-content-crowdsec" class="anchor" aria-label="Permalink: Crowdsec" href="#crowdsec"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>

<p>Note: If you don't <a href="https://docs.crowdsec.net/docs/next/configuration/crowdsec_configuration/#sharing" rel="nofollow">disable sharing in crowdsec</a>, you may need to mention that <a href="https://docs.crowdsec.net/docs/central_api/intro/#signal-meta-data" rel="nofollow">this</a> is sent to crowdsec in your privacy policy.</p>
<ol>
<li>Install crowdsec and the ZoeyVid/npmplus collection for example by using crowdsec container at the end of the compose.yaml, you may also want to install <a href="https://app.crowdsec.net/hub/author/crowdsecurity/collections/http-dos" rel="nofollow">this</a>, but be warned of false positives</li>
<li>Set LOGROTATE to <code>true</code> in your <code>compose.yaml</code> and redeploy</li>
<li>Open <code>/opt/crowdsec/conf/acquis.d/npmplus.yaml</code> (path may be different depending how you installed crowdsec) and fill it with:</li>
</ol>
<div class="highlight highlight-source-yaml"><pre><span class="pl-ent">filenames</span>:
  - <span class="pl-s">/opt/npmplus/nginx/logs/*.log</span>
<span class="pl-ent">labels</span>:
  <span class="pl-ent">type</span>: <span class="pl-s">npmplus</span>
---
<span class="pl-ent">listen_addr</span>: <span class="pl-s">0.0.0.0:7422</span>
<span class="pl-ent">appsec_config</span>: <span class="pl-s">crowdsecurity/appsec-default</span>
<span class="pl-ent">name</span>: <span class="pl-s">appsec</span>
<span class="pl-ent">source</span>: <span class="pl-s">appsec</span>
<span class="pl-ent">labels</span>:
  <span class="pl-ent">type</span>: <span class="pl-s">appsec</span>
<span class="pl-c"><span class="pl-c">#</span> if you use openappsec you can enable this</span>
<span class="pl-c"><span class="pl-c">#</span>---</span>
<span class="pl-c"><span class="pl-c">#</span>source: file</span>
<span class="pl-c"><span class="pl-c">#</span>filenames:</span>
<span class="pl-c"><span class="pl-c">#</span> - /opt/openappsec/logs/cp-nano-http-transaction-handler.log*</span>
<span class="pl-c"><span class="pl-c">#</span>labels:</span>
<span class="pl-c"><span class="pl-c">#</span>  type: openappsec</span></pre></div>
<ol start="4">
<li>Make sure to use <code>network_mode: host</code> in your compose file for the NPMplus container</li>
<li>Run <code>docker exec crowdsec cscli bouncers add npmplus</code> and save the api key of the output</li>
<li>Open <code>/opt/npmplus/crowdsec/crowdsec.conf</code>
</li>
<li>Set <code>ENABLED</code> to <code>true</code>
</li>
<li>Use the output of step 5 as <code>API_KEY</code>
</li>
<li>Save the file</li>
<li>Redeploy the <code>compose.yaml</code>
</li>
<li>It is recommended to block at the earliest possible point, so if possible set up a firewall bouncer: <a href="https://docs.crowdsec.net/u/bouncers/firewall" rel="nofollow">https://docs.crowdsec.net/u/bouncers/firewall</a>, make sure to also include the docker iptables in the firewall bouncer config</li>
<li>Note that when using crowdsec requests will always be buffered, so setting <code>proxy_(request_)buffering</code> to off will not work</li>
</ol>
<div class="markdown-heading"><h2 class="heading-element">Use of external php-fpm (recommended)</h2><a id="user-content-use-of-external-php-fpm-recommended" class="anchor" aria-label="Permalink: Use of external php-fpm (recommended)" href="#use-of-external-php-fpm-recommended"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<ol>
<li>Create a new Proxy Host with some dummy data in the details tab (since these get fully ignored)</li>
<li>Make other settings (like TLS)</li>
<li>Create a custom location <code>/</code> set the scheme to <code>path</code>, put in the path, the press the gear button and fill this in (edit the last line):</li>
</ol>
<pre><code>location ~* \.php(?:$|/) {
  fastcgi_split_path_info ^(.*\.php)(/.*)$;
  try_files $fastcgi_script_name =404;
  fastcgi_pass ...; # set this to the address of your php-fpm (socket/tcp): https://nginx.org/en/docs/http/ngx_http_fastcgi_module.html#fastcgi_pass
}
</code></pre>
<div class="markdown-heading"><h2 class="heading-element">Use of inbuilt php-fpm (not recommended)</h2><a id="user-content-use-of-inbuilt-php-fpm-not-recommended" class="anchor" aria-label="Permalink: Use of inbuilt php-fpm (not recommended)" href="#use-of-inbuilt-php-fpm-not-recommended"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<ol>
<li>First enable php inside your compose file (you can add more php extension using envs in the compose file)</li>
<li>Set the forwarding port to the php version you want to use and is supported by NPMplus (like 83/84/85)</li>
</ol>
<div class="markdown-heading"><h2 class="heading-element">Comments on some buttons</h2><a id="user-content-comments-on-some-buttons" class="anchor" aria-label="Permalink: Comments on some buttons" href="#comments-on-some-buttons"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<ul>
<li>Forward Hostname / IP / Path: if the scheme is set to path you can just put here a path in and nginx works as a file server, otherwise you need to input ip/domain, you can also append a path to the ip/domain like <code>127.0.0.1/path</code> to proxy to a subpath.
<ul>
<li>For custom locations with a set path, dns will be only refreshed on nginx reloads and the path of the location will be stripped. So a request <code>GET /cdf/abc</code> to a custom location <code>/cdf</code> which proxies to <code>127.0.0.1/abc</code> will proxy to <code>127.0.0.1/abc/abc</code>, a custom location <code>/cdf/</code> which proxies to <code>127.0.0.1/</code> will proxy to <code>127.0.0.1/abc</code>  and a custom location <code>/cdf</code> which proxies to <code>127.0.0.1</code> will proxy to <code>127.0.0.1/cdf/abc</code>
</li>
<li>If the scheme is set to <code>path</code>, a path ending with a <code>/</code> will be searched relative to the custom location (is uses nginx alias) and a path ending without a <code>/</code> will be searched relative to the main <code>/</code> location (it uses nginx root)</li>
</ul>
</li>
<li>Forward Port (optional): port of upstream or php version if scheme is <code>path</code>
</li>
<li>Send noindex header and block some user agents: This does what is says, it appends a header to all responses which says that the site should not be indexed while blocking requests of crawlers based on the user agent sent with the request</li>
<li>Disable Crowdsec Appsec: this will disable crowdsec appsec only for one host/one location</li>
<li>Disable Response Buffering: Most time you want keep buffering enabled, you may want to disable this if you for example want to stream videos and you have a fast and stable connection to the upstream server, this effects the connection from the upstream server to NPMplus</li>
<li>Disable Request Buffering: Most time you want keep buffering enabled, request buffering will always be enabled if crowdsec appsec is enabled, you may want to disable this if you for example want to upload huge files and have a fast and stable connection to the upstream server, this effects the connection from the NPMplus to the upstream server</li>
<li>Enable compression by upstream: this will allow the backend to compress files, I recommend you to keep this disabled, there may be cases where this is needed since otherwise the upstream missbehaves for some reason (like collabora in nextcloud all-in-one)</li>
<li>Enable fancyindex: this will enabled fancyindex, which shows a index of all files in the folder if there is no index file, only enable this if you know what you are doing and you need the index</li>
<li>Websockets: this button was removed, websockets are now always enabled</li>
<li>Reuse Key: this will make the new cert always keep its key unless you force renew it, I recommend you to keep this disabled (not to keep the key), a reason to keep the key would be TLSA/pubkey pinning</li>
<li>TLS to upstream (for Streams): This can be used if your stream target already uses tls but you want to override it with a NPMplus cert, do not enable if you don't set a new cert, since this will downgrade the connecting to be unencrypted</li>
<li>X-Frame-Options: will control the X-Frame-Options header, none will remove the header, SAMEORIGIN/DENY will set it to these values and upstream will keep what upstream sends</li>
</ul>
<div class="markdown-heading"><h2 class="heading-element">Examples of implementing some services using auth_request</h2><a id="user-content-examples-of-implementing-some-services-using-auth_request" class="anchor" aria-label="Permalink: Examples of implementing some services using auth_request" href="#examples-of-implementing-some-services-using-auth_request"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<div class="markdown-heading"><h3 class="heading-element">Anubis</h3><a id="user-content-anubis" class="anchor" aria-label="Permalink: Anubis" href="#anubis"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<ol>
<li>Deploy an anubis container (see the compose.yaml for an example and information)</li>
<li>In the mounted anubis bot policy file the "status_codes" should be set to 401 and 403, like this:</li>
</ol>
<div class="highlight highlight-source-yaml"><pre><span class="pl-ent">status_codes</span>:
  <span class="pl-ent">CHALLENGE</span>: <span class="pl-c1">401</span>
  <span class="pl-ent">DENY</span>: <span class="pl-c1">403</span></pre></div>
<ol start="3">
<li>Set the AUTH_REQUEST_ANUBIS_UPSTREAM env in the NPMplus compose.yaml and select anubis in the Auth Request selection, no custom/advanced config/locations needed</li>
<li>You can override the images used by default by creating a custom location <code>/.within.website/x/cmd/anubis/static/img</code> which acts as a file server and serves the files <code>happy.webp</code>, <code>pensive.webp</code> and <code>reject.webp</code>
</li>
</ol>
<div class="markdown-heading"><h3 class="heading-element">Tinyauth</h3><a id="user-content-tinyauth" class="anchor" aria-label="Permalink: Tinyauth" href="#tinyauth"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<ol>
<li>Set the AUTH_REQUEST_TINYAUTH_UPSTREAM and AUTH_REQUEST_TINYAUTH_UPSTREAM env in the NPMplus compose.yaml and select tinyauth in the Auth Request selection, no custom/advanced config/locations needed</li>
</ol>
<div class="markdown-heading"><h3 class="heading-element">Authelia (modern)</h3><a id="user-content-authelia-modern" class="anchor" aria-label="Permalink: Authelia (modern)" href="#authelia-modern"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<ol>
<li>Set the AUTH_REQUEST_AUTHELIA_UPSTREAM env in the NPMplus compose.yaml and select authelia (modern) in the Auth Request selection, no custom/advanced config/locations needed</li>
</ol>
<div class="markdown-heading"><h3 class="heading-element">Authentik</h3><a id="user-content-authentik" class="anchor" aria-label="Permalink: Authentik" href="#authentik"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<ol>
<li>Set the AUTH_REQUEST_AUTHENTIK_UPSTREAM env (and optional AUTH_REQUEST_AUTHENTIK_DOMAIN env if you use "domain level", this env may not work if you use the "single application" variant) in the NPMplus compose.yaml and select authentik/authentik-send-basic-auth in the Auth Request selection, no custom/advanced config/locations needed</li>
</ol>
<div class="markdown-heading"><h2 class="heading-element">Load Balancing</h2><a id="user-content-load-balancing" class="anchor" aria-label="Permalink: Load Balancing" href="#load-balancing"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<ol>
<li>Open and edit this file: <code>/opt/npmplus/custom_nginx/http_top.conf</code> (or <code>/opt/npmplus/custom_nginx/stream_top.conf</code> for streams), if you changed /opt/npmplus to a different path make sure to change the path to fit</li>
<li>Set the upstream directive(s) with your servers which should be load balanced (<a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html" rel="nofollow">https://nginx.org/en/docs/http/ngx_http_upstream_module.html</a> / <a href="https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html" rel="nofollow">https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html</a>), they need to run the same protocol (either http(s) or grpc(s) for proxy hosts or tcp/udp/proxy protocol for streams), like this for example:</li>
</ol>
<pre><code>upstream server1 {
  server 127.0.0.1:44;
  server 127.0.0.1:33;
  server 127.0.0.1:22;
  server 192.158.168.11:44 backup;
}
</code></pre>
<ol start="3">
<li>Configure your proxy host/stream like always in the UI, but set the hostname to service1 (or service2 or however you named it) and keep the forward port field empty (since you set the ports within the upstream directive)</li>
</ol>
<div class="markdown-heading"><h2 class="heading-element">Geoblocking example (mainly community support)</h2><a id="user-content-geoblocking-example-mainly-community-support" class="anchor" aria-label="Permalink: Geoblocking example (mainly community support)" href="#geoblocking-example-mainly-community-support"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<ol>
<li>set the <code>NGINX_LOAD_GEOIP2_MODULE</code> env to true and redeploy NPMplus</li>
<li>deploy a geoipupdate container (see the compose.yaml for an example, create credentials <a href="https://www.maxmind.com/en/geolite2/signup" rel="nofollow">here</a>)</li>
<li>open and edit this file: <code>/opt/npmplus/custom_nginx/http_top.conf</code>, if you changed /opt/npmplus to a different path make sure to change the path to fit</li>
</ol>
<div class="highlight highlight-source-yaml"><pre><span class="pl-s">geoip2 /data/goaccess/geoip/GeoLite2-Country.mmdb {</span>
  <span class="pl-s">auto_reload 60m;</span>
  <span class="pl-s">$geoip2_country_iso_code country iso_code;</span>
<span class="pl-s">}</span>

<span class="pl-c"><span class="pl-c">#</span> whitelist example, you can add as many country codes as you want, country code list: https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2#XY</span>
<span class="pl-c"><span class="pl-c">#</span>map $geoip2_country_iso_code $geoip2_country_rule {</span>
<span class="pl-c"><span class="pl-c">#</span>  default no;</span>
<span class="pl-c"><span class="pl-c">#</span>  AA yes;</span>
<span class="pl-c"><span class="pl-c">#</span>  XY yes;</span>
<span class="pl-c"><span class="pl-c">#</span>  '' yes; # if you want to allow IPs with unknown country codes, if you don't do this make sure to allow private IPs</span>
<span class="pl-c"><span class="pl-c">#</span>}</span>

<span class="pl-c"><span class="pl-c">#</span> blacklist example, you can add as many country codes as you want, country code list: https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2#XY</span>
<span class="pl-c"><span class="pl-c">#</span>map $geoip2_country_iso_code $geoip2_country_rule {</span>
<span class="pl-c"><span class="pl-c">#</span>  default yes;</span>
<span class="pl-c"><span class="pl-c">#</span>  AA no;</span>
<span class="pl-c"><span class="pl-c">#</span>  XY no;</span>
<span class="pl-c"><span class="pl-c">#</span>  '' no; # if you want to block IPs with unknown country codes, if you do this make sure to allow private IPs</span>
<span class="pl-c"><span class="pl-c">#</span>}</span>

<span class="pl-c"><span class="pl-c">#</span> uncomment if you block/don't allow IPs with unknown country codes</span>
<span class="pl-c"><span class="pl-c">#</span>geo $is_private_ip {</span>
<span class="pl-c"><span class="pl-c">#</span>  default no;</span>
<span class="pl-c"><span class="pl-c">#</span>  127.0.0.0/8 yes;</span>
<span class="pl-c"><span class="pl-c">#</span>  10.0.0.0/8 yes;</span>
<span class="pl-c"><span class="pl-c">#</span>  172.16.0.0/12 yes;</span>
<span class="pl-c"><span class="pl-c">#</span>  192.168.0.0/16 yes;</span>
<span class="pl-c"><span class="pl-c">#</span>  169.254.0.0/16 yes;</span>
<span class="pl-c"><span class="pl-c">#</span>  ::1/128 yes;</span>
<span class="pl-c"><span class="pl-c">#</span>  fc00::/7 yes;</span>
<span class="pl-c"><span class="pl-c">#</span>  fec0::/10 yes;</span>
<span class="pl-c"><span class="pl-c">#</span>}</span></pre></div>
<p>4a. to set it per location: create a custom location / (or the location you want to use), set your proxy settings, then press the gear button and paste the following in the new text field, you may want to adjust the last lines (do not use the advanced tab with this example as it may break cert renewals):</p>
<div class="highlight highlight-source-yaml"><pre><span class="pl-c"><span class="pl-c">#</span> uncomment if you block/don't allow IPs with unknown country codes</span>
<span class="pl-c"><span class="pl-c">#</span>if ($is_private_ip = yes) { </span>
<span class="pl-c"><span class="pl-c">#</span>  set $geoip2_country_rule yes; </span>
<span class="pl-c"><span class="pl-c">#</span>} </span>
<span class="pl-s">if ($geoip2_country_rule = no) { </span>
  <span class="pl-s">return 444; </span><span class="pl-c"><span class="pl-c">#</span> this rejects the connection, but you can also return 403 to tell the client that it was denied</span>
<span class="pl-s">} </span></pre></div>
<p>4b. to set it for an entire host: put this in the advanced tab:</p>
<div class="highlight highlight-source-yaml"><pre><span class="pl-c"><span class="pl-c">#</span> uncomment if you block/don't allow IPs with unknown country codes</span>
<span class="pl-c"><span class="pl-c">#</span>if ($is_private_ip = yes) { </span>
<span class="pl-c"><span class="pl-c">#</span>  set $geoip2_country_rule yes; </span>
<span class="pl-c"><span class="pl-c">#</span>}</span>
<span class="pl-s">if ($request_uri ~* "^/\.well-known/acme-challenge/") {</span>
    <span class="pl-s">set $geoip2_country_rule yes;</span>
<span class="pl-s">}</span>
<span class="pl-s">if ($geoip2_country_rule = no) { </span>
  <span class="pl-s">return 444; </span><span class="pl-c"><span class="pl-c">#</span> this rejects the connection, but you can also return 403 to tell the client that it was denied</span>
<span class="pl-s">} </span></pre></div>
<p>4c. to set it for all http hosts of them same type: put this in the <code>custom_nginx/server_proxy.conf</code> / <code>custom_nginx/server_redirect.conf</code> / <code>custom_nginx/server_dead.conf</code> file(s):</p>
<div class="highlight highlight-source-yaml"><pre><span class="pl-c"><span class="pl-c">#</span> uncomment if you block/don't allow IPs with unknown country codes</span>
<span class="pl-c"><span class="pl-c">#</span>if ($is_private_ip = yes) { </span>
<span class="pl-c"><span class="pl-c">#</span>  set $geoip2_country_rule yes; </span>
<span class="pl-c"><span class="pl-c">#</span>}</span>
<span class="pl-s">if ($request_uri ~* "^/\.well-known/acme-challenge/") {</span>
    <span class="pl-s">set $geoip2_country_rule yes;</span>
<span class="pl-s">}</span>
<span class="pl-s">if ($geoip2_country_rule = no) { </span>
  <span class="pl-s">return 444; </span><span class="pl-c"><span class="pl-c">#</span> this rejects the connection, but you can also return 403 to tell the client that it was denied</span>
<span class="pl-s">} </span></pre></div>
<p>4d. to set it for all http hosts: put this in the <code>custom_nginx/server_http.conf</code> file:</p>
<div class="highlight highlight-source-yaml"><pre><span class="pl-c"><span class="pl-c">#</span> uncomment if you block/don't allow IPs with unknown country codes</span>
<span class="pl-c"><span class="pl-c">#</span>if ($is_private_ip = yes) { </span>
<span class="pl-c"><span class="pl-c">#</span>  set $geoip2_country_rule yes; </span>
<span class="pl-c"><span class="pl-c">#</span>}</span>
<span class="pl-s">if ($request_uri ~* "^/\.well-known/acme-challenge/") {</span>
    <span class="pl-s">set $geoip2_country_rule yes;</span>
<span class="pl-s">}</span>
<span class="pl-s">if ($geoip2_country_rule = no) { </span>
  <span class="pl-s">return 444; </span><span class="pl-c"><span class="pl-c">#</span> this rejects the connection, but you can also return 403 to tell the client that it was denied</span>
<span class="pl-s">} </span></pre></div>
<ol start="5">
<li>you can create multiple rule lists by adding multiple map directive, but you need to use a unique name instead of <code>$geoip2_country_rule</code> for each rule list (you need the unique name also in the custom locations)</li>
</ol>
<div class="markdown-heading"><h2 class="heading-element">Prerun scripts (EXPERT option) - if you don't know what this is, ignore it</h2><a id="user-content-prerun-scripts-expert-option---if-you-dont-know-what-this-is-ignore-it" class="anchor" aria-label="Permalink: Prerun scripts (EXPERT option) - if you don't know what this is, ignore it" href="#prerun-scripts-expert-option---if-you-dont-know-what-this-is-ignore-it"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>If you need to run scripts before NPMplus launches put them under: <code>/opt/npmplus/prerun/*.sh</code> (please add <code>#!/usr/bin/env sh</code> / <code>#!/usr/bin/env bash</code> to the top of the script) you need to create this folder yourself, also set the <code>ENABLE_PRERUN</code> env to <code>true</code></p>
<div class="markdown-heading"><h2 class="heading-element">Notes on Cloudflare</h2><a id="user-content-notes-on-cloudflare" class="anchor" aria-label="Permalink: Notes on Cloudflare" href="#notes-on-cloudflare"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<ul>
<li>I strongly advise against using cloudflare proxy/tunnel before NPMplus (so between the users and NPMplus <code>users &lt;=&gt; cloudflare &lt;=&gt; NPMplus</code>)</li>
<li>Why?
<ul>
<li>cloudflare acts like a "man in the middle" (if you want you can also call it a "wanted man-in-the-middle attack"), this means all traffic going from your users to you/from you to your users will be decrypted by cloudflare before being encrypted again and being forwarded to you/your users, if you want this is your decision (security, privacy, etc.)</li>
<li>many optimizations done by NPMplus will because of this only be used between cloudflare and NPMplus, so your users won't notice them</li>
<li>cloudflare overrides many things done/configured by NPMplus (like headers (including HSTS), HTTP/3 (QUIC), TLS settings and more), so you might need to configure them again in Cloudflare, but this is not always possible</li>
<li>cloudflare has a limit of 100MB per connection, so uploading/downloading big files my cause problems, if no chunking is used</li>
<li>because all data does not take direct way between your users and you, the connection time will increase</li>
<li>cloudflare only forwards/protects http(s) traffic on port 80/443 to you, services running on other ports/different protocols are not forwarded/protected (STUN/TURN/SSH)</li>
<li>cloudflare can't protect you if the attacker knows your real ip, as cloudflare only rewrites your dns entries to itself and then acts as a reverse proxy, direct ip connectings to you are not protected (use a firewall like ufw, make sure to allow 80/tcp and 443/tcp+udp for NPMplus, if possible don't open SSH and NPMplus GUI to the internet, but secure them behind a VPN like Wireguard)</li>
<li>if you need a WAF =&gt; use <a href="#crowdsec">crowdsec</a>
</li>
<li>if you want to use the "I'm under attack mode" to protect you from (ai) web scrapes =&gt; use <a href="#anubis-config-supported">anubis</a>
</li>
</ul>
</li>
<li>What are reason for cloudflare?
<ul>
<li>The points above don't matter you (enough) and:
<ul>
<li>you depend on a not mentioned and unreplaceable feature of cloudflare</li>
<li>or you are under (a) DDoS-attack(s), which you can't handle yourself and the attacker does not know your real ip/does not use it to attack you, but instead your domain: you could use cloudflare as dns nameserver for your domain with the proxy disabled and only enable it if you are under an attack (only work if the attacker did not cache your real ip)</li>
<li>or you want to hide your IP and only expose http(s) services, but then: don't use NPMplus at all, install cloudflared and use cloudflare tunnels and point it directly to your upstreams, this way you can still manage everything in a GUI and you don't even need to expose any ports</li>
</ul>
</li>
</ul>
</li>
<li>If you still want to use cloudflare proxy make sure to set <code>your domain =&gt; SSL/TLS =&gt; SSL/TLS encryption =&gt; Current encryption mode =&gt; Configure</code> to "Full (strict)"</li>
<li>Just using cloudflare as a dns nameserver provider for your domain is fine</li>
<li>If you use cloudflare to forward mails to your inbox, note that cloudflare also acts as man-in-the-middle in this case</li>
</ul>
<div class="markdown-heading"><h2 class="heading-element">Hints for Your Privacy Policy</h2><a id="user-content-hints-for-your-privacy-policy" class="anchor" aria-label="Permalink: Hints for Your Privacy Policy" href="#hints-for-your-privacy-policy"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p><strong>Note: This is not legal advice. The following points are intended to give you hints and help you identify areas that may be relevant to your privacy policy. This list may not be complete or correct.</strong></p>
<ol>
<li>NPMplus <strong>always</strong> writes the nginx error logs to your Docker logs; it uses the error level “warn” (so every error nginx and the nginx modules mark as error level “warn” or higher will be logged), as it contains user information (like IPs) you should mention it in your privacy policy. With the default installation no user data should leave your system because of NPMplus (except for data sent to your backends, as this is the task of a reverse proxy), this should be the only data created by NPMplus containing user information by default.</li>
<li>If you enable <code>LOGROTATE</code> the access and error (also level “warn”), logs will be written to your disk and rotated every 25 hours and deleted based on your set number of set rotations. The access logs use these formats: <a href="https://github.com/ZoeyVid/NPMplus/blob/c6a2df722390eb3f4377c603e16587fe8c74e54f/rootfs/usr/local/nginx/conf/nginx.conf#L30">http</a> and <a href="https://github.com/ZoeyVid/NPMplus/blob/c6a2df722390eb3f4377c603e16587fe8c74e54f/rootfs/usr/local/nginx/conf/nginx.conf#L249">stream</a>. These include user information (like IPs), so make sure to also mention that these exist and what you are doing with them.</li>
<li>If you use crowdsec, and you do <strong>not</strong> <a href="https://docs.crowdsec.net/docs/next/configuration/crowdsec_configuration/#sharing" rel="nofollow">disable sharing in crowdsec</a>, you need to mention that <a href="https://docs.crowdsec.net/docs/central_api/intro/#signal-meta-data" rel="nofollow">this</a> is sent to crowdsec in your privacy policy.</li>
<li>If you're blocking IPs — for example, using access lists, GeoIP filtering, or CrowdSec block lists — make sure to mention this as well.</li>
<li>If GoAccess is enabled, it processes access logs to generate statistics, which are saved on disk for a time you can configure. These statistics include user information (like IPs), so make sure to also mention this.</li>
<li>If you use the PHP-FPM option, error logs from PHP-FPM will also be written to Docker logs. These include user information (like IPs), so make sure to also mention this.</li>
<li>If you use open-appsec <code>NGINX_LOAD_OPENAPPSEC_ATTACHMENT_MODULE</code>, you should also include information about it; since I don't use it myself, I can't give you any further hints.</li>
<li>If you collect any user information (like through other custom nginx modules, modules you can load via env, lua scripts, etc.), also mention it.</li>
<li>If you use the caddy http to https redirect container, you should also mention the data collected by it, since it will also collect (error) logs.</li>
<li>If use use anubis, see here: <a href="https://anubis.techaro.lol/docs/admin/configuration/impressum" rel="nofollow">https://anubis.techaro.lol/docs/admin/configuration/impressum</a>
</li>
<li>If you do any extra custom/advanced configuration/modification, which is in someway related to the users data, then yes, keep in mind to also mention this.</li>
<li>Anything else you do with the users data, should also be mentioned. (Like what your backend does or any other proxies in front of NPMplus (like cloudflare, still not recommended), how data is stored, duration, ads, analytic tools, how data is handled if they contact you, by who/which provider, etc.)</li>
<li>I don't think this needs to be mentioned, but you can include it if you want to be thorough (note: this does not apply if you're using Let's Encrypt, as they no longer support OCSP): Some clients (like Firefox) send OCSP requests to the certificate authority (CA) by default if the CA includes OCSP URLs in the certificate. This behavior can be disabled by users in Firefox. In my opinion, it doesn't need to be mentioned, as no data is sent to you — the client communicates directly with the CA. The check is initiated by the client itself; it's neither requested nor required by you. Your certificate simply indicates that the client can perform this check if it chooses to.</li>
<li>Also optional and, in my opinion, not required: Some information about the data stored by the nameservers running your domain. I don't think this should be required, since in most cases there's a provider between the users and your nameserver acting as a proxy. This means the DNS requests of your users are hidden behind their provider. It’s the provider who should explain to their users how they handle data in their role as a "DNS proxy."</li>
</ol>
<div class="markdown-heading"><h2 class="heading-element">What connections can be expected from the NPMplus container?</h2><a id="user-content-what-connections-can-be-expected-from-the-npmplus-container" class="anchor" aria-label="Permalink: What connections can be expected from the NPMplus container?" href="#what-connections-can-be-expected-from-the-npmplus-container"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<ul>
<li>to your clients</li>
<li>to your upstreams</li>
<li>to your acme/ocsp server</li>
<li>to github for a daily update check</li>
<li>if not disabled gravatar for profile pictures</li>
<li>if used to your OIDC</li>
<li>if used to pypi to download certbot plugins</li>
<li>if used to your dns provider for acme dns challenges</li>
<li>if used to <a href="http://www.site24x7.com" rel="nofollow">www.site24x7.com</a> for the reachability check</li>
<li>if enabled to cloudflare to download theier IPs</li>
<li>if enabled to the crowdsec (container) lapi</li>
<li>if you see more/others please report them</li>
</ul>
<div class="markdown-heading"><h2 class="heading-element">Features and Project Goal of Upstream</h2><a id="user-content-features-and-project-goal-of-upstream" class="anchor" aria-label="Permalink: Features and Project Goal of Upstream" href="#features-and-project-goal-of-upstream"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>I created this project to fill a personal need to provide users with an easy way to accomplish reverse proxying hosts with TLS termination and it had to be so easy that a monkey could do it. This goal hasn't changed. While advanced configuration options are available, they remain entirely optional. The core idea is to keep things as simple as possible, lowering the barrier to entry for everyone.</p>
<ul>
<li>Beautiful and Secure Admin Interface based on <a href="https://tabler.github.io" rel="nofollow">Tabler</a>
</li>
<li>Easily create forwarding domains, redirections, streams and 404 hosts without knowing anything about Nginx</li>
<li>Free trusted TLS certificates using Certbot (Let's Encrypt/other CAs) or provide your own custom TLS certificates</li>
<li>Access Lists and basic HTTP Authentication for your hosts</li>
<li>Advanced Nginx configuration available for super users</li>
<li>User management, permissions and audit log</li>
</ul>
<div class="markdown-heading"><h2 class="heading-element">Contributing</h2><a id="user-content-contributing" class="anchor" aria-label="Permalink: Contributing" href="#contributing"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>All are welcome to create pull requests for this project, but this does not mean that they will be merged, so better ask if your PR would be merged before creating one (via Discussion), typos and translation are excluded from this.</p>
<div class="markdown-heading"><h1 class="heading-element">Please report issues first to this fork before reporting them to the upstream repository</h1><a id="user-content-please-report-issues-first-to-this-fork-before-reporting-them-to-the-upstream-repository" class="anchor" aria-label="Permalink: Please report issues first to this fork before reporting them to the upstream repository" href="#please-report-issues-first-to-this-fork-before-reporting-them-to-the-upstream-repository"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<div class="markdown-heading"><h2 class="heading-element">Getting Help</h2><a id="user-content-getting-help" class="anchor" aria-label="Permalink: Getting Help" href="#getting-help"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<ol>
<li>
<a href="https://github.com/ZoeyVid/NPMplus/discussions">Support/Questions</a> (preferred)</li>
<li>
<a href="https://discord.gg/y8DhYhv427" rel="nofollow">Discord</a> (only in the #support-npmplus forum channel, keep other channels free from NPMplus)</li>
<li>
<a href="https://reddit.com/r/NPMplus" rel="nofollow">Reddit</a> (not recommended)</li>
<li>
<a href="https://github.com/ZoeyVid/NPMplus/issues">Bugs</a> (only for feature requests and reproducible bugs)</li>
</ol>

